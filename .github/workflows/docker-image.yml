name: Docker Image CI

on:
  push:
    branches: [ main, feature/Docker ]
  pull_request:
    branches: [ main ]

jobs:

  build:
    env:
      tag: ${{ github.run_id }}


    runs-on: self-hosted

    steps:

    # Checkout code on self-hosted runner
    - uses: actions/checkout@v3
    
    # Build Docker-Image
    - name: Build the Docker image (now)
      run : docker build --tag ${{ secrets.JF_ARTIFACTORY_REGISTRY }}/aws-windows-docker-local/my-image-windows-2:${{ env.tag }} .
    
    # Run Docker-Image
    - name: Run image
      run : docker run --rm ${{ secrets.JF_ARTIFACTORY_REGISTRY }}/aws-windows-docker-local/my-image-windows-2:${{ env.tag }}
      
    # Login to JFrog-Registry
    - name: Login to JFrog-Registry
      uses: docker/login-action@v1 
      with:
        registry: ${{ secrets.JF_ARTIFACTORY_REGISTRY }}
        username: ${{ secrets.JF_ARTIFACTORY_USER }}
        password: ${{ secrets.JF_ARTIFACTORY_PASSWORD }}
  
    # Push docker image
    - name: Push Docker-Image
      run: docker push ${{ secrets.JF_ARTIFACTORY_REGISTRY }}/aws-windows-docker-local/my-image-windows-2:${{ env.tag }}
    
    # Delete Docker-Image
    - name: Delete Docker-Image 
      run: |
        docker rmi ${{ secrets.JF_ARTIFACTORY_REGISTRY }}/aws-windows-docker-local/my-image-windows-2:${{ env.tag }}